# 视图与显示控制逻辑 (View & Display Control)

**文档位置**: `crates/kernel/view_control.md`
**关联模块**: `interaction`, `display`

## 1. 摄像机系统 (Camera System)

摄像机是连接用户操作与渲染结果的核心组件。

### 1.1 数据结构
```rust
pub struct Camera {
    pub position: Vec3,
    pub target: Vec3,
    pub up: Vec3,
    pub fov: f32,
    pub projection_type: ProjectionType, // Perspective / Orthographic
}
```

### 1.2 控制流
*   **Orbit (轨道旋转)**: 保持 `target` 不变，`position` 在球面上移动。
*   **Pan (平移)**: `position` 和 `target` 同时移动，保持相对向量不变。
*   **Zoom (缩放)**: 
    *   透视投影: 改变 `position` 与 `target` 的距离。
    *   正交投影: 改变视口宽高的缩放倍率。

## 2. 显示模式管理 (Render Modes)

显示模式本质上是 **WGPU Pipeline State** 的切换。

### 2.1 模式定义
*   **Shaded**: 标准 PBR 着色，启用深度测试，剔除背面。
*   **Wireframe**: `wgpu::PolygonMode::Line`，可能需要 `DepthBias` 防止 Z-fighting。
*   **Transparent**:启用 Alpha Blending，需要从后向前排序绘制。

### 2.2 实现策略
Display 模块预创建多条 Pipeline：
```rust
struct PipelineSet {
    shaded: wgpu::RenderPipeline,
    wireframe: wgpu::RenderPipeline,
    picking: wgpu::RenderPipeline, // 用于颜色编码拾取
}
```
Kernel 根据当前 `RenderConfig` 告诉 Display 在 `RenderPass` 中使用哪条 Pipeline。

## 3. 视图动画 (View Transitions)

为了提供流畅的 UX，视图切换（如从透视切到顶视图）应包含过渡动画。

### 3.1 插值器 (Interpolator)
Kernel 的 `Update` 循环中包含动画系统：
```rust
if let Some(anim) = &mut self.camera_animation {
    let t = (now - anim.start_time) / anim.duration;
    if t >= 1.0 {
        self.camera = anim.end_val;
        self.camera_animation = None;
    } else {
        // 使用球形插值 (Slerp) 保证旋转平滑
        self.camera.position = slerp(anim.start_pos, anim.end_pos, t);
    }
}
```

## 4. 视口操作
*   **背景色**: 映射到 `wgpu::Color` -> `ClearValue`。
*   **天空盒**: 作为一个特殊的、总是最后绘制且深度为无穷远的 Cube Mesh 处理。

---
# 文档关系 (Document Relationships)
- **上级 (Parent)**: [[核心逻辑.md]]
- **下级 (Children)**: 无
