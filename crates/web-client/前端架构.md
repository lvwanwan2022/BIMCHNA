# 前端架构 (Web Client) 设计文档

**文档位置**: `crates/web-client/前端架构_id_18000000_level_1_parentId_00000000_time_20251226_Creator_lvwan01.md`
**关联模块**: `bridge` (通信), `app` (宿主环境)
**最近更新**: 2025-12-26

## 1. 核心目标 (Vision)

本模块不仅仅是一个简单的前端页面，而是 **BIMCHNA 的统一 UI 宿主平台**。它负责集成和管理所有的交互界面元素，使开发者能够灵活地使用 Web 技术（HTML/CSS/JS）构建复杂的桌面级 UI。

**核心能力**:
*   **命令中心 (Command System)**: 统一管理所有用户指令的入口。
*   **工具箱 (Tool System)**: 交互式绘图和编辑工具的状态展示。
*   **面板系统 (Panel System)**: 支持停靠、浮动、折叠的侧边栏（如模型树、属性面板）。
*   **对话框与窗口 (Dialogs & Windows)**: 模态/非模态窗口管理。

## 2. 技术栈选型

*   **框架**: Vue 3 (Composition API) + TypeScript
    *   *理由*: 响应式数据绑定非常适合实时 UI 更新（如属性面板随选中物体变化）。
*   **构建工具**: Vite (快速构建，支持 WASM)
*   **状态管理**: Pinia (管理 UI 布局状态、当前激活工具、选中集)
*   **UI 组件库**: TailwindCSS + Shadcn/ui
    *   *特点*: 轻量、可深度定制，能够创建类似 IDE 的专业界面风格。
*   **布局引擎**: GoldenLayout (或自研轻量级 Flex 布局)
    *   *用途*: 实现类似 Visual Studio 或 Blender 的可拖拽停靠布局。

## 3. 架构设计

### 3.1 界面层级 (Layering)

整个前端应用分为三层：

1.  **Overlay Layer (透明交互层)**:
    *   覆盖在 Rust WGPU 渲染画布之上。
    *   CSS: `pointer-events: none` (默认穿透)，`pointer-events: auto` (UI 元素响应)。
    *   包含：Toolbar (工具栏)、StatusBar (状态栏)、Floating Panels (浮动面板)。

2.  **Docking Layer (停靠布局层)**:
    *   位于屏幕左右/底部边缘。
    *   包含：模型结构树 (Model Tree)、属性面板 (Properties)、输出窗口 (Output)。
    *   支持用户自定义布局（拖拽、调整大小）。

3.  **Dialog Layer (弹窗层)**:
    *   最高层级，用于模态对话框（设置、确认）或非模态工具窗口。

### 3.2 动态面板注册机制

为了实现“随时使用 HTML 做一个面板”，我们需要一个注册表机制。

```typescript
// src/core/ui_registry.ts

export type PanelType = 'model-tree' | 'properties' | 'console' | string;

interface PanelDefinition {
    id: PanelType;
    title: string;
    component: any; // Vue Component
    defaultLocation: 'left' | 'right' | 'bottom';
}

class UIRegistry {
    registerPanel(def: PanelDefinition) { ... }
    openPanel(id: PanelType) { ... }
}
```

**示例：创建模型结构树面板**

1.  创建 Vue 组件 `src/panels/ModelTree.vue`。
2.  在启动时注册：
    ```typescript
    uiRegistry.registerPanel({
        id: 'model-tree',
        title: '模型结构',
        component: ModelTree,
        defaultLocation: 'left'
    });
    ```
3.  Rust 后端或前端逻辑调用 `ui.openPanel('model-tree')` 即可显示。

## 4. 目录结构

```
crates/web-client/
├── index.html
├── src/
│   ├── api/            # 封装 Bridge (Tauri/WASM)
│   ├── core/           # 核心 UI 逻辑
│   │   ├── commands.ts # 命令管理器
│   │   ├── layout.ts   # 布局管理器
│   │   └── registry.ts # 组件注册表
│   ├── components/     # 通用 UI 组件 (Button, Input, TreeView)
│   ├── panels/         # 具体业务面板
│   │   ├── ModelTree.vue    # 模型结构树
│   │   ├── Properties.vue   # 属性面板
│   │   └── Toolbox.vue      # 工具箱
│   ├── dialogs/        # 弹窗
│   │   ├── Settings.vue
│   │   └── Login.vue
│   ├── stores/         # Pinia 状态
│   └── main.ts
└── package.json
```

## 5. 核心交互流

### 5.1 命令系统集成

前端不仅是显示，还是命令的触发源。

1.  **定义命令**:
    *   在 Rust 端定义 `Command::DeleteSelection`。
    *   在前端注册对应 UI 表现（快捷键 Del，图标 trash.svg）。

2.  **触发流程**:
    *   用户点击前端 "删除" 按钮。
    *   前端 `CommandManager` 捕获事件。
    *   前端调用 `bridge.sendCommand("execute_command", "DeleteSelection")`。
    *   Rust 核心执行逻辑，修改数据。
    *   Rust 发送事件 `EntityDeleted`。

3.  **UI 反馈**:
    *   前端监听 `EntityDeleted`。
    *   `ModelTree` 组件收到事件，从树形列表中移除对应节点。
    *   `Properties` 面板收到事件，清空当前显示。

### 5.2 模型结构树面板 (Model Tree Panel) 实现细节

这是一个典型的“HTML 面板”案例。

*   **数据源**: 不在前端维护完整模型数据的副本，而是维护一份轻量级的 **View Model (视图模型)**。
*   **同步机制**:
    *   初始化时：`bridge.query("get_scene_hierarchy")` 获取树结构。
    *   更新时：监听 `SceneGraphChanged` 事件（节点增删改）。
*   **交互**:
    *   **点击节点**: 调用 `bridge.sendCommand("select_entity", { id })`。
    *   **右键菜单**: 前端弹出 HTML 菜单 -> 触发 "Hide/Show", "Rename" 等命令。
    *   **拖拽**: 使用 HTML5 Drag & Drop API，结束时发送 `reparent_entity` 指令给 Rust。

## 6. 通信协议 (Bridge)

依然采用双向通信适配器模式，但增强了对 UI 状态的支持。

```typescript
interface Bridge {
    // 发送指令到 Rust
    sendCommand(cmd: string, payload: any): Promise<void>;
    
    // 从 Rust 获取数据 (RPC 风格)
    query(query: string, params: any): Promise<any>;
    
    // 监听 Rust 事件
    onEvent(event: string, callback: (payload: any) => void): void;
}
```

## 7. 开发路线图

1.  **阶段一**: 搭建基础 Vue3 + Pinia 框架，实现 Bridge 通信打通。
2.  **阶段二**: 实现布局管理器 (Layout Manager)，支持左/右侧边栏切换。
3.  **阶段三**: 开发核心面板——**模型结构树** 和 **属性面板**。
4.  **阶段四**: 实现命令系统与快捷键绑定。
5.  **阶段五**: 样式美化与主题系统 (Dark/Light mode)。

---
# 文档关系 (Document Relationships)
- **上级 (Parent)**: [[总框架.md]]
- **下级 (Children)**: 无
