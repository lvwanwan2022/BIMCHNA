# 文档信息
- **文件名**: 显示引擎
- **原始文件名**: 显示引擎_id_12000000_level_1_parentId_00000000_time_20251218_Creator_lvwan01
- **Level**: 1
- **ID**: 12000000
- **ParentID**: 00000000
- **Time**: 20251218
- **Creator**: lvwan01

---

# 显示引擎设计 (Display Engine)

## 1. 模块概述
基于 wgpu (WebGPU/Vulkan/Metal) 的高性能渲染后端，负责将几何内核的数据实时可视化。

## 2. 架构设计 (RHI)
*   **Backend**: wgpu (Cross-platform Abstraction).
*   **Abstraction**: RenderGraph 设计，自动管理资源屏障和同步。
*   **Shader**: WGSL 实现，支持 PBR (Physically Based Rendering) 工作流。

## 3. 视口系统设计 (Viewport System)

视口系统负责管理渲染的输出窗口、摄像机状态以及用户的观察交互。

### 3.1 视口布局 (Viewport Layout)
*   **多视口支持**: 核心支持，UI 层可配置。
*   **投影模式**:
    *   `Perspective`: 透视投影。
    *   `Orthographic`: 正交投影，支持 `ortho_width` 动态调整。

### 3.2 导航交互 (Navigation)
*   **摄像机控制器 (CameraController)**:
    *   **Orbit Mode (绕物旋转)**:
        *   基于球坐标系 (Distance, Yaw, Pitch) 计算 Eye 位置。
        *   Z-Axis Up 坐标系。
        *   操作: Rotate (Orbit), Pan (平移 Target), Zoom (调整 Distance)。
    *   **Game Mode (漫游模式)**:
        *   Eye 为主，基于 Yaw/Pitch 计算 View Direction。
        *   支持 WASD 移动 (Forward, Right, Up) 和鼠标 Look。
*   **视图操作**:
    *   `zoom_to_fit`: 自动聚焦包围盒中心。
    *   `zoom_selected`: 聚焦选中物体（当前以固定点演示）。
    *   `save_view` / `undo_view`: 视图历史栈支持。

### 3.3 显示模式 (Display Modes)
渲染管线支持多种 Fragment Shader 路径：
*   **Wireframe**: 线框模式。
*   **Shaded**: 基础光照模型 (Lambert + Specular)，无 PBR 材质。
*   **Material Preview (PBR)**:
    *   **光照模型**: Cook-Torrance BRDF (GGX Distribution, Smith Geometry, Fresnel Schlick)。
    *   **光源**: Key Light, Fill Light, Rim Light 三点布光 + IBL 环境光近似。
    *   **材质支持**: Metallic, Roughness, Opacity, Emission, Texture Mapping (Diffuse)。
    *   **后处理**: ACES Tone Mapping, Gamma Correction。
*   **Artistic/Sketch**: 边缘检测风格渲染 (Shader 中 `params.y` 控制)。
*   **Selection**: 选中物体高亮渲染 (固定颜色 overlay)。

### 3.4 拾取系统 (Picking)
*   **状态**: 骨架代码已建立 (`picking.rs`)，具体 Ray-cast 或 GPU Picking 逻辑待实现。

## 4. FBX 导入与显示逻辑
当前核心逻辑位于 `crates/app/src/ui/mod.rs`。

### 4.1 实现逻辑
1.  **文件解析**: 使用 `fbxcel_dom` 解析 FBX 7400+ 版本文件。
2.  **资源缓存**:
    *   建立 `geometry_map`, `material_map`, `model_map`。
3.  **全局变换 (Global Transform)**:
    *   实现了完整的层级变换计算 `get_global_transform`。
    *   解析 `Lcl Translation`, `Lcl Rotation` (Euler XYZ), `Lcl Scaling`。
    *   递归应用父节点变换：`Global = ParentGlobal * Local`。
4.  **材质解析**:
    *   支持多材质 Mesh (按 Polygon Index 映射)。
    *   读取 Phong/Lambert 材质属性：Diffuse Color, Specular, Shininess, Emissive。
    *   映射到 PBR 参数：
        *   Specular Factor -> Metallic (近似)
        *   Shininess -> Roughness (反向映射)
        *   Transparency -> Opacity
5.  **渲染提交**:
    *   将计算后的 World Space 顶点数据提交给 `BimView`。
    *   支持顶点颜色、法线、UV、材质参数的传递。

### 4.2 遗留问题与计划
*   **纹理支持**: 代码中包含纹理路径解析逻辑，但完整加载流程待完善。
*   **法线处理**: 目前直接使用 FBX 数据，未处理平滑组或重新计算法线。
*   **动画**: 不支持骨骼蒙皮动画。

---
# 文档关系 (Document Relationships)
- **上级 (Parent)**: [[总框架.md]]
- **下级 (Children)**:
  - [[渲染管线.md]]
